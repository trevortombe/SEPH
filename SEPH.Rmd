---
title: "Survey of Employment, Payrolls and Hours"
author: "Trevor Tombe"
date: ""
output:
  html_document:
    includes:
      after_body: footer.html
    theme: spacelab
    toc: yes
    toc_float: yes
  word_document:
    toc: yes
  pdf_document:
    toc: yes
always_allow_html: yes
---

```{r setup, include=FALSE}
library(knitr)
knitr::opts_chunk$set(message=F, warning=F,fig.width = 7,fig.height = 3.75,fig.align="center",cache=TRUE,echo=F,dpi=300)

```

```{r load data, include=F}
source("core.R")

# Fetches Latest SEPH Data
seph<-getTABLE("14100223")
sourcetable<-"Statistics Canada data table 14-10-0223"
today=max(seph$Ref_Date) # the latest month in the data

# Constructs Employment Data
sephemp<-seph %>%
  filter(Estimate=="Employment for all employees",
         grepl("Industrial aggregate including unclassified businesses",NAICS))

# Wage and Salary Data
wagedata<-getTABLE("14100222")

# Fixed weight dex of average hourly earnings
fixedweight<-getTABLE("14100213")

# Over time hours and earnings -- hourly and salaried employees are separate data
OTpay<-getTABLE("14100205")
OThours<-getTABLE("14100255")
earn_salary_data<-getTABLE("14100209")
hours_salary_data<-getTABLE("14100211")

# Detailed sector job information
jobdetailed<-getTABLE("14100201")

# Useful dates
thismonth=as.character(today)
lastmonth=as.character(today-1/12)
lastyear=as.character(today-1-1/12)

```

<style>
div.blue { background-color:#e6f0ff; border-radius: 5px; padding: 20px;}
</style>
<div class = "blue">
Each month Statistics Canada releases comprehensive data on the state of Canada's labour markets. The Survey of Employment, Payroll and Hours is based on firm-level administrative payroll data. This is distinct from the Labour Force Survey, which is another important source of labour market information.
</div>

# Change in Employment, by Province {.tabset .tabset-fade}
Displays the change in payroll employment and employment rates. First, since the start of Alberta's recession. Then compares provinces.

## Alberta

```{r growth}
startdate="Oct 2014"
plotdata<-sephemp %>%
  filter(Ref_Date>=startdate & GEO=="Alberta") %>%
  group_by(GEO) %>%
  mutate(change=Value-max(Value*(Ref_Date==startdate)))
ggplot(plotdata,aes(Ref_Date,change/1000))+
  geom_line(size=2) +
  geom_point(data=plotdata %>% filter(Ref_Date==max(Ref_Date)),size=4)+
	geom_hline(aes(yintercept=0), colour="black", size=1) +
  geom_text(data=plotdata[plotdata$Ref_Date==max(plotdata$Ref_Date),],
            aes(x=Ref_Date,y=change/1000,label=paste(round(change/1000),"k",sep="")),
            hjust=0,vjust=-0.5,fontface="bold",size=5,color="firebrick") +
  mytheme+
  scale_y_continuous(breaks=pretty_breaks(n=8)) +
  scale_x_yearmon(limit=c(2014.75,max(plotdata$Ref_Date)+1/12),breaks=pretty_breaks(n=8),format = "%b\n%Y") +
	labs(x="",y="Thousands of Jobs",title=paste("Change in",plotdata$GEO[1],"Payroll Jobs Since",startdate),
		subtitle="Note: The 2015-16 recession started in October 2014. Source: Statistics Canada table 14-10-0223",caption="Graph by @trevortombe")

province<-"Alberta"
lfsdata<-fromJSON("http://economicdashboard.alberta.ca/Download/DownloadFile?extension=JSON&requestUrl=http%3A%2F%2Feconomicdashboard.alberta.ca%2Fapi%2FEmployment")
startdate="Dec 2014"
plotdata <- lfsdata %>%
  mutate(Ref_Date=as.yearmon(as.Date(When))) %>%
  filter(Ref_Date>=startdate,Characteristic=="Employment") %>%
  select(Ref_Date,emp=Alberta) %>%
  mutate(change=(emp-emp[1]),
         Group="Labour Force Survey ('Employment')") %>%
  bind_rows(plotdata<-sephemp %>%
              filter(Ref_Date>=startdate & GEO=="Alberta") %>%
              group_by(GEO) %>%
              mutate(change=Value-max(Value*(Ref_Date==startdate))) %>% 
              mutate(Group="Payroll Data ('Jobs')") %>% select(Ref_Date,change,Group))
ggplot(plotdata,aes(Ref_Date,change/1000,group=Group,color=Group))+
  geom_hline(yintercept=0,size=1) +
  geom_line(size=2,lineend="round") +
	mytheme+
	scale_colour_brewer(name="",palette="Set1") +
	scale_y_continuous(breaks=pretty_breaks(n=8)) +
  scale_x_yearmon(breaks=pretty_breaks(n=8),format = "%b\n%Y") +
  labs(x="",y="Thousands of Persons",title=paste("Change in Alberta Employment Since",startdate),
		subtitle=paste("Source: Own calculations from",sourcetable,"and 14-10-0287."),caption="Graph by @trevortombe")

```

```{r level in Alberta}
startdate<-"Jan 2012"
plotdata<-sephemp %>%
  filter(Ref_Date>=startdate & GEO=="Alberta")
ggplot(plotdata,aes(Ref_Date,Value/1000))+
  annotate("rect",xmin=as.numeric(as.yearmon("Oct 2014")), xmax=as.numeric(as.yearmon("Oct 2016")), 
           ymin=-Inf, ymax=+Inf, alpha=0.2, fill="dodgerblue")+
  annotate("text",x=2015.71, y=Inf, vjust=1,
           label="Recession",color="black",size=3,fontface="italic")+
  geom_line(size=2,color="firebrick") +
  geom_point(data=plotdata %>% filter(Ref_Date==max(Ref_Date)),size=3,color="firebrick")+
  mytheme+
  scale_y_continuous(breaks=pretty_breaks(n=8),label=comma) +
  scale_x_yearmon(breaks=pretty_breaks(n=8),format = "%Y") +
  labs(x="",y="Thousands of Jobs",title=paste("Total Payroll Employment in",plotdata$GEO),
       subtitle=paste("Source: Own calculations from",sourcetable),caption="Graph by @trevortombe")

plotdata<-seph %>%
      filter(Estimate=="Employment for all employees",GEO=="Alberta",Ref_Date>=startdate,
         grepl("Industrial aggregate excluding unclassified businesses",NAICS)) %>%
  select(Ref_Date,emp=Value) %>%
  left_join(
    seph %>%
      filter(Estimate=="Average weekly earnings including overtime for all employees",GEO=="Alberta",
             grepl("Industrial aggregate excluding unclassified businesses",NAICS)) %>%
      select(Ref_Date,pay=Value)
  ) %>%
  mutate(total_earnings=4*pay*emp/1000000)
ggplot(plotdata,aes(Ref_Date,total_earnings))+
  annotate("rect",xmin=as.numeric(as.yearmon("Oct 2014")), xmax=as.numeric(as.yearmon("Oct 2016")), 
           ymin=-Inf, ymax=+Inf, alpha=0.2, fill="dodgerblue")+
  annotate("text",x=2015.71, y=Inf, vjust=1,
           label="Recession",color="black",size=3,fontface="italic")+
  geom_line(size=2,color="firebrick") +
  geom_point(data=plotdata %>% filter(Ref_Date==max(Ref_Date)),size=3,color="firebrick")+
  mytheme+
  scale_y_continuous(breaks=pretty_breaks(n=8),label=comma) +
  scale_x_yearmon(breaks=pretty_breaks(n=8),format = "%Y") +
  labs(x="",y="Millions of Dollars per Month",title="Total Payroll Compensation in Alberta",
       subtitle=paste("Source: Own calculations from",sourcetable),caption="Graph by @trevortombe")

```

## All Provinces
```{r all provinces}
startdate="Jan 2015"
plotdata<-sephemp %>%
  filter(Ref_Date>=startdate & GEO!="Yukon" & GEO!="Northwest Territories" &
           GEO!="Nunavut") %>%
  group_by(GEO) %>%
  mutate(change=Value/Value[1]-1)
ggplot(plotdata,aes(x=Ref_Date,y=change,group=short,color=short)) +
	geom_line(size=1,show.legend=FALSE,color="gray")+
  geom_line(data=plotdata %>% filter(short %in% c("AB","BC","ON","SK","QC","CAN")),size=2,show.legend = F)+
	geom_hline(aes(yintercept=0), colour="black", size=1) +
  mytheme+
  geom_text_repel(data=plotdata %>% filter(Ref_Date==max(Ref_Date),short %in% c("AB","ON","SK","BC","QC","CAN")),aes(label=short,x=Ref_Date,y=change),xlim=c(as.numeric(max(plotdata$Ref_Date)),NA),fontface="bold",size=4,show.legend = F)+
  scale_y_continuous(breaks=pretty_breaks(n=8),label=percent) +
  scale_x_yearmon(breaks=pretty_breaks(n=8),format = "%b\n%Y",
                  limit=c(NA,max(plotdata$Ref_Date)+2/12)) +
  labs(x="",y="Per Cent Change (%)",title=paste("Change in Payroll Jobs in Canada,",startdate,"to",today),
		subtitle=paste("Source: Own calculations from",sourcetable),
		caption="Graph by @trevortombe")+
  scale_color_ptol()

# Change in Payroll Employment, All Provinces
plotdata<-sephemp %>%
  filter(Ref_Date>=startdate & GEO!="Yukon" & GEO!="Northwest Territories" &
           GEO!="Canada" & GEO!="Nunavut") %>%
  group_by(short) %>%
  mutate(change=Value-lag(Value,1)) %>%
  filter(Ref_Date==max(Ref_Date))
ggplot(plotdata,aes(short,change))+
  geom_col(fill="dodgerblue3")+
  geom_hline(yintercept=0,size=1)+
  mythemebar+
  scale_y_continuous(label=comma)+
  labs(x="",y="Number of Payroll Jobs",
       title=paste("Change in Payroll Employment,",lastmonth,"to",thismonth),
       subtitle=paste("Source: Own calculations from",sourcetable),
       caption="Graph by @trevortombe")

```

# By Sector
Growth in employment, by sector.

```{r by sector}
plotdata<-as_tibble(seph) %>%
  filter(GEO=="Alberta" & Ref_Date>="Jan 2016" & 
           !(NAICS %in% c("Industrial aggregate including unclassified businesses",
                          "Industrial aggregate excluding unclassified businesses",
                          "Goods producing industries","Service producing industries",
                          "Durable goods","Non-durable goods","Trade"))) %>%
  select(Ref_Date,Estimate,NAICS,Value) %>%
  mutate(
    NAICS=replace(NAICS,NAICS=="Administrative and support, waste management and remediation services","Admin Support & Waste"),
    NAICS=replace(NAICS,NAICS=="Other services (except public administration)","Other Service"),
    NAICS=replace(NAICS,NAICS=="Mining, quarrying, and oil and gas extraction","Mining/Oil/Gas"),
    NAICS=replace(NAICS,NAICS=="Forestry, logging and support","Forestry"),
    NAICS=replace(NAICS,NAICS=="Accommodation and food services","Hotel/Restaurants"),
    NAICS=replace(NAICS,NAICS=="Arts, entertainment and recreation","Arts, enter., rec."),
    NAICS=replace(NAICS,NAICS=="Professional, scientific and technical services","Professional/Scientific"),
    NAICS=replace(NAICS,NAICS=="Real estate and rental and leasing","Real Estate"),
    NAICS=replace(NAICS,NAICS=="Transportation and warehousing","Transport/Storage"),
    NAICS=replace(NAICS,NAICS=="Information and cultural industries","Information/Culture"),
    NAICS=replace(NAICS,NAICS=="Health care and social assistance","Health/Social"),
    NAICS=replace(NAICS,NAICS=="Management of companies and enterprises","Mgmt of Companies")
    ) %>%
  arrange(Estimate,NAICS,Ref_Date) %>%
  group_by(Estimate,NAICS) %>%
  mutate(change=Value-lag(Value,12))
ggplot(filter(plotdata,Estimate=="Employment for all employees" & Ref_Date==max(Ref_Date)),
       aes(reorder(NAICS,change),change)) +
  geom_bar(stat="identity",fill="dodgerblue3") +
  geom_hline(yintercept=0,size=1)+
  coord_flip() +
  mythemebarflip+
  scale_y_continuous(breaks=pretty_breaks(n=6),label=comma)+
  labs(x="",y="Number of Payroll Jobs",
       title=paste("Change in Alberta's Payroll Jobs,",lastyear,"to",thismonth),
       subtitle="Source: Statistics Canada data table 14-10-0223.",caption="Graph by @trevortombe.")

plotdata<-as_tibble(seph) %>%
  filter(GEO=="Alberta" & Ref_Date>="Jan 2016" & 
           !(NAICS %in% c("Industrial aggregate including unclassified businesses",
                          "Industrial aggregate excluding unclassified businesses",
                          "Goods producing industries","Service producing industries",
                          "Durable goods","Non-durable goods","Trade"))) %>%
  select(Ref_Date,Estimate,NAICS,Value) %>%
  mutate(
    NAICS=replace(NAICS,NAICS=="Administrative and support, waste management and remediation services","Admin Support & Waste"),
    NAICS=replace(NAICS,NAICS=="Other services (except public administration)","Other Service"),
    NAICS=replace(NAICS,NAICS=="Mining, quarrying, and oil and gas extraction","Mining/Oil/Gas"),
    NAICS=replace(NAICS,NAICS=="Forestry, logging and support","Forestry"),
    NAICS=replace(NAICS,NAICS=="Accommodation and food services","Hotel/Restaurants"),
    NAICS=replace(NAICS,NAICS=="Arts, entertainment and recreation","Arts, enter., rec."),
    NAICS=replace(NAICS,NAICS=="Professional, scientific and technical services","Professional/Scientific"),
    NAICS=replace(NAICS,NAICS=="Real estate and rental and leasing","Real Estate"),
    NAICS=replace(NAICS,NAICS=="Transportation and warehousing","Transport/Storage"),
    NAICS=replace(NAICS,NAICS=="Information and cultural industries","Information/Culture"),
    NAICS=replace(NAICS,NAICS=="Health care and social assistance","Health/Social"),
    NAICS=replace(NAICS,NAICS=="Management of companies and enterprises","Mgmt of Companies")
    ) %>%
  arrange(Estimate,NAICS,Ref_Date) %>%
  group_by(Estimate,NAICS) %>%
  mutate(change=Value-lag(Value,1))
ggplot(filter(plotdata,Estimate=="Employment for all employees" & Ref_Date==max(Ref_Date)),
       aes(reorder(NAICS,change),change)) +
  geom_bar(stat="identity",fill="dodgerblue3") +
  geom_hline(yintercept=0,size=1)+
  coord_flip() +
  mythemebarflip+
  scale_y_continuous(breaks=pretty_breaks(n=6),label=comma)+
  labs(x="",y="Number of Payroll Jobs",
       title=paste("Change in Alberta's Payroll Jobs,",lastmonth,"to",thismonth),
       subtitle="Source: Own calculations from Statistics Canada data table 14-10-0223.",caption="Graph by @trevortombe.")

# Shift in Alberta's employment composition
start="Oct 2014"
seph<-seph %>% data.table()
plotdata<-seph[GEO=="Alberta" & Estimate=="Employment for all employees" & Ref_Date>=start & NAICS!="Industrial aggregate including unclassified businesses" &
                 NAICS!="Industrial aggregate excluding unclassified businesses" & NAICS!="Durable goods" & NAICS!="Trade" &
                 NAICS!="Goods producing industries" & NAICS!="Service producing industries" & NAICS!="Non-durable goods"]
plotdata[,totalemp:=sum(Value),by=Ref_Date]
plotdata[,share:=Value/totalemp]
plotdata<-plotdata[Ref_Date==start | Ref_Date==max(Ref_Date)]

test2<-dcast(plotdata[,.(Ref_Date,NAICS,share)],NAICS~Ref_Date)
test2[NAICS=="Administrative and support, waste management and remediation services"]$NAICS<-"Admin Support & Waste"
test2[NAICS=="Other services (except public administration)"]$NAICS<-"Other Service"
test2[NAICS=="Mining, quarrying, and oil and gas extraction"]$NAICS<-"Mining/Oil/Gas"
test2[NAICS=="Forestry, logging and support"]$NAICS<-"Forestry"
test2[NAICS=="Accommodation and food services"]$NAICS<-"Hotel/Restaurants"
test2[NAICS=="Arts, entertainment and recreation"]$NAICS<-"Arts, enter., rec."
test2[NAICS=="Professional, scientific and technical services"]$NAICS<-"Professional/Scientific"
test2[NAICS=="Real estate and rental and leasing"]$NAICS<-"Real Estate"
test2[NAICS=="Transportation and warehousing"]$NAICS<-"Transport/Storage"
test2[NAICS=="Information and cultural industries"]$NAICS<-"Information/Culture"
test2[NAICS=="Health care and social assistance"]$NAICS<-"Health/Social"
test2[NAICS=="Management of companies and enterprises"]$NAICS<-"Mgmt of Corps."
setnames(test2,start,"start")
setnames(test2,paste(today),"end")
test2<-test2[order(test2$start),]
test2$NAICS<-factor(test2$NAICS,levels=test2$NAICS)
test2[,change:=end-start]
test2[,arrowend:=change-0.001*(change>0)+0.001*(change<0)]
ggplot(test2, aes(x=start, xend=end, y=NAICS, group=NAICS)) + 
  geom_segment(aes(xend=start+arrowend,yend=NAICS),color="royalblue",
               arrow = arrow(type="closed",length = unit(0.15,"cm")))+
  geom_dumbbell(color="royalblue", 
                size=1, 
                size_x=2,
                colour_xend="firebrick",
                size_xend=4)+
  geom_text(data=test2 %>% filter(NAICS=="Mining/Oil/Gas"),
            aes(x=end, y="Mining/Oil/Gas", label=paste(today)),
            color="firebrick", hjust=1, size=3, nudge_y=0.5, nudge_x=-0.002)+
  geom_text(aes(x=0.068, y="Mining/Oil/Gas", label="Oct 2014"),
            color="royalblue", hjust=0, size=3, nudge_y=0.5)+
  geom_vline(xintercept = 0,size=1)+
  mytheme+
  scale_x_continuous(expand=c(0,0),limits=c(0,0.13),label=percent,breaks=pretty_breaks(n=8)) + 
  labs(x="Share of Total Payroll Employment (%)", 
       y=NULL, 
       title="The Changing Composition of Alberta's Jobs", 
       subtitle="Source: Own calculations from Statistics Canada data table 14-10-0223. The recession started Oct 2014.",
       caption="Graph by @trevortombe")
```

```{r sector high low wages}
# Change in employment by wage high vs lower wages
plotdata<-seph %>%
  filter(GEO=="Alberta",!(NAICS %in% c("Industrial aggregate including unclassified businesses",
                                       "Industrial aggregate excluding unclassified businesses","Durable goods",
                                       "Non-durable goods","Trade",
                                       "Goods producing industries","Service producing industries"))) %>%
  mutate(variable=ifelse(grepl("Employment",Estimate),"emp","earn")) %>%
  select(Ref_Date,NAICS,variable,Value) %>%
  spread(variable,Value) %>%
  left_join(OTpay %>% filter(GEO=="Alberta",
                             Overtime=="Excluding overtime") %>%
              select(Ref_Date,NAICS,wage=Value),by=c("NAICS","Ref_Date")) %>%
  group_by(NAICS) %>%
  mutate(startemp=weighted.mean(emp,Ref_Date=="Oct 2014"),
         startwage=weighted.mean(wage,Ref_Date=="Oct 2014"),
         change=emp-startemp,
         above30=(startwage>=30)*1,
         above30=ifelse(is.na(above30),0,above30)) %>%
  group_by(Ref_Date,above30) %>%
  summarise(change=sum(change))
ggplot(plotdata %>% filter(Ref_Date>="Oct 2014"),aes(Ref_Date,change,group=above30,color=as.character(above30)))+
  geom_hline(yintercept=0,size=1)+
  geom_line(size=2,show.legend = F)+
  annotate("text",x=2018.7,hjust=1,y=25000,label="Average Wages Below $30",
           color="firebrick",fontface="bold")+
  annotate("text",x=2017,hjust=0,y=-65000,label="Average Wages Above $30",
           color="dodgerblue3",fontface="bold")+
  geom_point(data=plotdata %>% filter(Ref_Date=="Oct 2014"),
             aes(y=0),size=3,color="black")+
  annotate('text',x=2014+9/12,y=20000,label="Start of\nRecession",size=3,hjust=0.5)+
  mytheme+
  scale_color_manual(name="",values=c("firebrick","dodgerblue3"))+
  scale_y_continuous("Change in Payroll Employment",label=comma,limit=c(NA,50000))+
  scale_x_continuous("")+
  labs(title="Employment Changes in Higher vs Lower Paying Sectors",
       subtitle="Displays the change in payroll employment in Alberta since October 2014 in sectors paying above and below $30 per hour.
Source: Own calculations from Statistics Canada data tables 14-10-0205 and 14-10-0223",
       caption="Graph by @trevortombe")

```


# Public vs Private
```{r public-v-private}
plotdata<-seph %>%
  filter(Estimate=="Employment for all employees",
         !NAICS %in% c("Industrial aggregate including unclassified businesses",
                       "Industrial aggregate excluding unclassified businesses",
                       "Goods producing industries","Non-durable goods",
                       "Durable goods","Service producing industries",
                       "Wholesale trade","Retail trade"),
         GEO=="Alberta",Ref_Date>="Oct 2014") %>%
  mutate(type=ifelse(NAICS %in% c("Public administration","Educational services",
                                   "Health care and social assistance"),
                     "Health, Educ., and Public Admin.",
                     "All Other Sectors")) %>%
  group_by(Ref_Date,type) %>%
  summarise(Value=sum(Value)) %>%
  group_by(type) %>%
  mutate(change=Value-Value[1])
ggplot(plotdata,aes(Ref_Date,change,group=type,color=type))+
  geom_line(size=2)+
  geom_hline(yintercept=0,size=1)+
  geom_point(data=plotdata %>% filter(Ref_Date=="Oct 2014"),
             aes(y=0),size=3,color="black")+
  annotate('text',x=2014+9/12,y=35000,label="Start of\nRecession",size=3,hjust=0)+
  annotate('text',x=2018,y=-75000,label="Little change in private\npayroll jobs since June 2017",size=3)+
  mytheme+
  scale_y_continuous(label=comma,expand=c(0,0),limit=c(-170000,100000),
                     breaks=pretty_breaks(n=6))+
  scale_color_brewer(name="",palette="Set1")+
  labs(x="",y="Number of Jobs",
       title="Change in Payroll Jobs Since Alberta's Recession Started",
       subtitle="Source: Own calculations from Statistics Canada data table 14-10-0223.",
       caption="Graph by @trevortombe")
```


# Earnings

```{r earnings}
plotdata<-seph %>%
  filter(Estimate=="Average weekly earnings including overtime for all employees",
                 NAICS=="Industrial aggregate excluding unclassified businesses",Ref_Date==max(Ref_Date)) %>%
  filter(!(short %in% c("CAN","NU","NT","YT")))
ggplot(plotdata, aes(x=short,y=Value)) +
	geom_col(fill="dodgerblue3") +
  geom_text(aes(label=paste0("$",round(Value))),vjust=1.5,color="white",fontface="bold")+
	geom_hline(aes(yintercept=0), colour="black", size=1) +
	mythemebar +
  scale_y_continuous(limits=c(0,1400),breaks=pretty_breaks(n=8),labels=dollar,expand=c(0,0)) +
	labs(x="",y="Dollars per Week",title=paste0("Average Weekly Earnings, by Province (",thismonth,")"),
		subtitle=paste("Source: Own calculations from",sourcetable),caption="Graph by @trevortombe")

startdate="Jan 2011"
plotdata<-seph %>%
  filter(Estimate=="Average weekly earnings including overtime for all employees",
         grepl("Industrial aggregate excluding unclassified businesses",NAICS),Ref_Date>=startdate &
           !(GEO %in% c("Nunavut","Northwest Territories","Yukon")))
ggplot(plotdata,aes(Ref_Date,Value,group=GEO))+
	geom_line(size = 1, color="gray") +
  geom_line(data=plotdata %>% filter(GEO %in% c("Alberta","Saskatchewan","Canada","Newfoundland and Labrador")),
            aes(Ref_Date,Value,group=GEO,color=GEO), size = 2) +
	mytheme +
	scale_colour_brewer(name="",palette="Set1") +
	scale_y_continuous(limit=c(700,1200),breaks=pretty_breaks(n=10),labels=dollar) +
	scale_x_yearmon(format = "%Y",n=8) +
	annotate(geom="text", x=2016, y=770,hjust=0, label="All Other Provinces",color="grey70",size=4,fontface="bold") +
	labs(x="",y="Dollars",title=paste("Average Weekly Earnings,",startdate,"to",today),
		subtitle=paste("Source: Own calculations from",sourcetable),caption="Graph by @trevortombe")

ggplot(plotdata %>% filter(GEO=="Alberta"),aes(Ref_Date,Value))+
  annotate("rect",xmin=as.numeric(as.yearmon("Oct 2014")), xmax=as.numeric(as.yearmon("Oct 2016")), 
           ymin=-Inf, ymax=+Inf, alpha=0.2, fill="dodgerblue")+
  annotate("text",x=2015.71, y=Inf, vjust=1.25,label="Recession",color="black",size=3,fontface="italic")+
  geom_line(size=2,color="firebrick") +
  geom_point(data=plotdata %>% filter(GEO=="Alberta",Ref_Date==max(Ref_Date)),size=3,color="firebrick")+
  mytheme +
  scale_y_continuous(labels=dollar,expand=c(0,0),limit=c(1000,1200)) +
  scale_x_yearmon(format = "%Y",breaks=seq(2011,2018)) +
  labs(x="",y="Dollars",title=paste("Average Weekly Earnings in Alberta,",startdate,"to",today),
       subtitle=paste("Source: Own calculations from",sourcetable),caption="Graph by @trevortombe")

plotdata<-seph %>%
  filter(Estimate=="Average weekly earnings including overtime for all employees",GEO %in% c("Canada","Alberta"),
         grepl("Industrial aggregate excluding unclassified businesses",NAICS)) %>%
  group_by(GEO) %>%
  mutate(change=Value/lag(Value,12)-1) %>%
  filter(Ref_Date>="Jan 2012")
ggplot(plotdata,aes(Ref_Date,change,group=GEO,color=GEO))+
  annotate("rect",xmin=as.numeric(as.yearmon("Oct 2014")), xmax=as.numeric(as.yearmon("Oct 2016")), 
           ymin=-Inf, ymax=+Inf, alpha=0.2, fill="dodgerblue")+
  annotate("text",x=2015.71, y=max(pretty(plotdata$change)), hjust=0.5, 
           label="AB Recession",color="black",size=3,fontface="italic")+
  geom_line(size=2) +
	geom_hline(aes(yintercept=0), colour="black", size=1) +
	mytheme +
  theme(legend.position = c(0.9,0.25))+
	scale_colour_brewer(name="",labels=c("Alberta","Canada"),palette="Set1") +
	scale_y_continuous(breaks=pretty_breaks(n=10),labels=percent) +
	scale_x_yearmon(format = "%b\n%Y",n=8) +
	labs(x="",y="Year-over-Year % Change",title="Change in Average Weekly Earnings (YoY %)",
		subtitle=paste("Source: Own calculations from",sourcetable),caption="Graph by @trevortombe")
```

## Real Wages in Alberta
```{r fetch CPI}
cpi<-getTABLE("18100006")
CPI<-cpi %>% 
  filter(Products.and.product.groups=="All-items") %>% 
  select(CPI=Value,Ref_Date)
```

```{r real earnings}
plotdata<-seph %>%
  filter(Estimate=="Average weekly earnings including overtime for all employees",
         grepl("Industrial aggregate excluding unclassified businesses",NAICS),
           GEO=="Alberta" & Ref_Date>="Jan 2010") %>%
  left_join(CPI,by="Ref_Date") %>%
  mutate(Real=Value*CPI[1]/CPI) %>%
  select(Ref_Date,Value,Real) %>%
  gather(type,value,-Ref_Date)
ggplot(plotdata,aes(Ref_Date,value,group=type,color=type))+
  annotate("rect",xmin=as.numeric(as.yearmon("Oct 2014")), xmax=as.numeric(as.yearmon("Oct 2016")), 
           ymin=-Inf, ymax=+Inf, alpha=0.2, fill="dodgerblue")+
  annotate("text",x=2015.71, y=Inf, vjust=1.25, 
           label="Recession",color="black",size=3,fontface="italic")+
  geom_line(size=2) +
	mytheme +
	scale_colour_brewer(name="",labels=c("Inflation-Adjusted (2010$)","Nominal Dollars"),palette="Set1") +
	scale_y_continuous(breaks=pretty_breaks(n=6),labels=dollar) +
	scale_x_yearmon(format = "%Y",n=8) +
	labs(x="",y="Dollars",title="Average Weekly Earnings in Alberta",
		subtitle=paste("Source: Own calculations from",sourcetable,"and 18-10-0006"),caption="Graph by @trevortombe")

ggplot(plotdata,aes(Ref_Date,value,group=type,color=type))+
  annotate("rect",xmin=as.numeric(as.yearmon("Oct 2014")), xmax=as.numeric(as.yearmon("Oct 2016")), 
           ymin=-Inf, ymax=+Inf, alpha=0.2, fill="dodgerblue")+
  annotate("text",x=2015.71, y=Inf, vjust=1.25, 
           label="Recession",color="black",size=3,fontface="italic")+
  geom_line(size=2) +
  geom_text(data=plotdata %>% filter(Ref_Date==max(Ref_Date)),aes(label=dollar_format()(round(value))),
            fontface="bold",vjust=-1,show.legend = F) +
  geom_point(data=plotdata %>% filter(Ref_Date==max(Ref_Date)),size=3,show.legend = F) +
	mytheme +
	scale_colour_manual(name="",labels=c("Inflation-Adjusted (2010$)","Nominal Dollars"),values=c("firebrick","dodgerblue3")) +
	scale_y_continuous(breaks=pretty_breaks(n=6),labels=dollar,limit=c(950,1225)) +
	scale_x_yearmon(format = "%Y",n=8) +
	labs(x="",y="Dollars",title="Average Weekly Earnings in Alberta",
		subtitle=paste("Source: Own calculations from",sourcetable,"and 18-10-0006"),caption="Graph by @trevortombe")

```

## Sectoral Earnings
```{r sectoral earnings}
start="Oct 2014"
empshare <- seph  %>%
  filter(GEO=="Alberta" & Estimate=="Employment for all employees" & Ref_Date>=start & 
           NAICS!="Industrial aggregate including unclassified businesses" &
                 NAICS!="Industrial aggregate excluding unclassified businesses" & NAICS!="Durable goods" & NAICS!="Trade" &
                 NAICS!="Goods producing industries" & NAICS!="Service producing industries" & NAICS!="Non-durable goods") %>%
  group_by(Ref_Date) %>%
  mutate(share=Value/sum(Value)) %>%
  ungroup() %>%
  select(Ref_Date,NAICS,share)
earn <- seph  %>%
  filter(GEO=="Alberta" & Estimate=="Average weekly earnings including overtime for all employees" & Ref_Date>=start & 
           NAICS!="Industrial aggregate including unclassified businesses" &
                 NAICS!="Industrial aggregate excluding unclassified businesses" & NAICS!="Durable goods" & NAICS!="Trade" &
                 NAICS!="Goods producing industries" & NAICS!="Service producing industries" & NAICS!="Non-durable goods") %>%
  select(Ref_Date,NAICS,earn=Value)
plotdata<-empshare %>%
  left_join(earn,by=c("NAICS","Ref_Date")) %>%
  drop_na() %>%
  group_by(NAICS) %>%
  mutate(initialshare=max((Ref_Date==start)*share)) %>%
  group_by(Ref_Date) %>%
  summarise(avgearn=weighted.mean(earn,share),
            avgearn_fixed=weighted.mean(earn,initialshare))
ggplot(plotdata,aes(Ref_Date,avgearn_fixed/avgearn))+
  geom_line()+
  labs(title="How much weekly earnings would be with fixed sector weights")

# The fixed weight index (brief discussion at https://www150.statcan.gc.ca/n1/pub/72-203-g/2013001/part-partie7-eng.htm)
fixedweight %>%
  filter(GEO %in% c("Canada","Alberta"),NAICS=="Industrial aggregate excluding unclassified businesses",
         Ref_Date>="Jan 2010") %>%
  getseas("GEO") %>%
  group_by(GEO) %>%
  mutate(Value=100*Value/max(Value*(Ref_Date=="Oct 2014")),
         TC=100*TC/max(TC*(Ref_Date=="Oct 2014"))) %>%
  ggplot(aes(Ref_Date,TC,color=GEO))+geom_line(size=2)+
  geom_line(aes(y=Value),linetype="dashed")+
  mytheme+
  scale_x_yearmon(format="%Y")+
  scale_color_brewer(name="",palette="Set1")+
  labs(y="Index (Oct 2014 = 100)",x="",title="Fixed weighted index of average hourly earnings of all employees",
       caption="Graph by @trevortombe",
       subtitle="Source: Own calculations from Statistics Canada data table 14-10-0213")

fixedweight %>%
  filter(GEO %in% c("Canada","Alberta"),NAICS=="Industrial aggregate excluding unclassified businesses",
         Ref_Date>="Jan 2010") %>%
  getseas("GEO") %>%
  group_by(GEO) %>%
  mutate(Value=100*Value/max(Value*(Ref_Date=="Oct 2014")),
         TC=100*TC/max(TC*(Ref_Date=="Oct 2014"))) %>%
  filter(Ref_Date>="Oct 2014") %>%
  mutate(change=Value/Value[1]-1) %>%
  filter(Ref_Date==max(Ref_Date)) %>%
  select(GEO,change)

fixedweight %>%
  filter(GEO %in% c("Canada","Alberta"),NAICS=="Industrial aggregate excluding unclassified businesses",
         Ref_Date>="Jan 2010") %>%
  getseas("GEO") %>%
  group_by(GEO) %>%
  mutate(Value=100*Value/weighted.mean(Value,(year(Ref_Date)==2014))) %>%
  select(-TC) %>%
  gettrend("Value") %>%
  filter(Ref_Date>="Jan 2014") %>%
  ggplot(aes(Ref_Date,TC,color=GEO))+
  geom_line(size=2)+
  geom_line(aes(y=Value),linetype="dashed")+
  mytheme+
  scale_x_yearmon(format="%Y")+
  scale_color_brewer(name="",palette="Set1")+
  labs(y="Index (2014 = 100)",x="",title="Fixed weighted index of average hourly earnings of all employees",
       caption="Graph by @trevortombe",
       subtitle="Source: Own calculations from Statistics Canada data table 14-10-0213")



```


## Hourly Wages vs Salaries

```{r wages}
## Weekly Earnings Change, hourly vs salary
sourcetable="Statistics Canada data table 14-10-0222"
province="Alberta"
startdate="Oct 2014"
plotdata<-wagedata %>%
  filter(GEO==province & (Estimate=="Average weekly earnings including overtime for hourly employees" |
	   Estimate=="Average weekly earnings including overtime for salaried employees")) %>%
  group_by(Estimate) %>%
  mutate(YoY=Value/lag(Value,12)-1) %>%
  filter(Ref_Date>=startdate) %>%
  mutate(change=Value/Value[1]-1)
ggplot(plotdata,aes(Ref_Date,change,group=Estimate,color=Estimate))+
	geom_line(size=2) +
	geom_hline(aes(yintercept=0), colour="black", size=1) +
	mytheme +
	scale_colour_brewer(name="",palette="Set1",label=c("Hourly Employees","Salaried Employees")) +
  scale_y_continuous(breaks=pretty_breaks(n=10),labels=percent) +
	scale_x_yearmon(format = "%b\n%Y") +
	labs(x="",y="Per Cent Change",title=paste("Change in",province,"Weekly Earnings Since",startdate),
		subtitle=paste("Source: Own calculations from ",sourcetable,sep=""),caption="Graph by @trevortombe")

ggplot(plotdata,aes(Ref_Date,Value,group=Estimate,color=Estimate))+
	geom_line(size=2) +
	geom_hline(aes(yintercept=0), colour="black", size=1) +
	mytheme +
	scale_colour_brewer(name="",palette="Set1",label=c("Hourly Employees","Salaried Employees")) +
  scale_y_continuous(breaks=pretty_breaks(n=10),labels=dollar) +
	scale_x_yearmon(format = "%Y") +
	labs(x="",y="Per Cent Change",title=paste("Change in",province,"Weekly Earnings Since",startdate),
		subtitle=paste("Source: Own calculations from ",sourcetable,sep=""),caption="Graph by @trevortombe")
```

```{r hourly_emp}
# Hourly vs Salaried employment
plotdata<-wagedata %>%
  filter(GEO==province & Ref_Date>=startdate &
	(Estimate=="Employment for hourly paid employees" |
	   Estimate=="Employment for salaried employees")) %>%
  group_by(Estimate) %>%
  mutate(change=Value-Value[1])
ggplot(plotdata,aes(Ref_Date,change/1000,group=Estimate,color=Estimate))+
  geom_line(size=2) +
	geom_hline(aes(yintercept=0), colour="black", size=1) +
	mytheme +
  scale_colour_brewer(name="",palette="Set1",label=c("Hourly Employees","Salaried Employees")) +
  scale_y_continuous(breaks=pretty_breaks(n=8),labels=comma) +
	scale_x_yearmon(breaks=pretty_breaks(n=8),format = "%b\n%Y") +
	labs(x="",y="Thousands of Jobs",title=paste("Change in",province,"Payroll Employment Since",startdate),
	     subtitle=paste("Source: Own calculations from ",sourcetable,sep=""),caption="Graph by @trevortombe")

plotdata2<-plotdata %>%
  group_by(Ref_Date) %>%
  mutate(total=sum(Value),
         share=Value/total) %>%
  filter(Estimate=="Employment for hourly paid employees")
ggplot(plotdata2,aes(Ref_Date,share))+
  geom_line(size=2,color="firebrick") +
	mytheme +
  scale_y_continuous(breaks=pretty_breaks(n=8),labels=percent) +
	scale_x_yearmon(breaks=pretty_breaks(n=8),format = "%Y") +
	labs(x="",y="Per Cent",title="Hourly Employees as a Share of Total in Alberta",
	     subtitle=paste("Source: Own calculations from ",sourcetable,sep=""),caption="Graph by @trevortombe")
```

```{r wage_vs_hours}
plotdata<-wagedata %>%
  filter(GEO==province & Ref_Date>=startdate &
	(Estimate=="Average hourly earnings including overtime for hourly employees" |
	   Estimate=="Average weekly hours including overtime for hourly employees")) %>%
  group_by(Estimate) %>%
  mutate(change=Value/Value[1]-1)
ggplot(plotdata,aes(Ref_Date,change,group=Estimate,color=Estimate))+
  geom_line(size=2) +
	geom_hline(aes(yintercept=0), colour="black", size=1) +
	mytheme +
  scale_colour_brewer(name="",palette="Set1",label=c("Hourly Wages","Hours per Week")) +
  scale_y_continuous(breaks=pretty_breaks(n=8),labels=percent,limit=c(-0.08,0.06)) +
	scale_x_yearmon(format = "%Y") +
	labs(x="",y="Per Cent Change",title=paste("Change in",province,"Hours/Wages for Hourly Workers since",startdate),
	     subtitle=paste("Source: Own calculations from ",sourcetable,sep=""),caption="Graph by @trevortombe")
```

```{r hours}
plotdata<-wagedata %>%
  filter(GEO==province & Estimate=="Average weekly hours including overtime for hourly employees") %>%
  filter(Ref_Date>="Jan 2000") %>%
  gettrend("Value")
ggplot(plotdata,aes(Ref_Date,TC))+
  annotate("rect",xmin=as.numeric(as.yearmon("Oct 2014")), xmax=as.numeric(as.yearmon("Oct 2016")), 
           ymin=-Inf, ymax=+Inf, alpha=0.2, fill="dodgerblue")+
  annotate("rect",xmin=as.numeric(as.yearmon("Sep 2008")), xmax=as.numeric(as.yearmon("Nov 2009")), 
           ymin=-Inf, ymax=+Inf, alpha=0.2, fill="dodgerblue")+
  annotate("text",x=2010, y=Inf, vjust=1.25, hjust=0,
           label="Recession",color="dodgerblue",size=3,fontface="italic",alpha=0.6)+
  geom_line(color="firebrick",linetype="dashed",aes(y=Value))+
  geom_line(size=2,color="firebrick")+
  mytheme +
  scale_y_continuous(breaks=pretty_breaks(n=6)) +
  scale_x_yearmon(format="%Y")+
  labs(x="",y="Hours per Week",title="Average weekly hours in Alberta for Hourly Employees",
       subtitle=paste("Source: Own calculations from ",sourcetable,"-- including overtime; for hourly employees only."),caption="Graph by @trevortombe")

plotdata<-OThours %>%
  filter(GEO==province & Overtime=="Excluding overtime",
         NAICS=="Industrial aggregate excluding unclassified businesses") %>%
  getseas("Overtime")
ggplot(plotdata,aes(Ref_Date,TC))+
  annotate("rect",xmin=as.numeric(as.yearmon("Oct 2014")), xmax=as.numeric(as.yearmon("Oct 2016")), 
           ymin=-Inf, ymax=+Inf, alpha=0.2, fill="dodgerblue")+
  annotate("rect",xmin=as.numeric(as.yearmon("Sep 2008")), xmax=as.numeric(as.yearmon("Nov 2009")), 
           ymin=-Inf, ymax=+Inf, alpha=0.2, fill="dodgerblue")+
  annotate("text",x=2010, y=Inf, vjust=1.25, hjust=0,
           label="Recession",color="dodgerblue",size=3,fontface="italic",alpha=0.6)+
  geom_line(color="firebrick",linetype="dashed",aes(y=Value))+
  geom_line(size=2,color="firebrick")+
  mytheme +
  scale_y_continuous(breaks=pretty_breaks(n=6)) +
  scale_x_yearmon(format="%Y")+
  labs(x="",y="Hours per Week",title="Average weekly hours in Alberta for Hourly Employees",
       subtitle=paste("Source: Own calculations from Statistics 14-10-0255 -- excluding overtime; for hourly employees only."),caption="Graph by @trevortombe")

plotdata<-wagedata %>%
  filter(GEO==province & Estimate=="Standard work week excluding overtime for salaried employees (exclude overtime)") %>%
  filter(Ref_Date>="Jan 2000") %>%
  gettrend("Value")
ggplot(plotdata,aes(Ref_Date,TC))+
  annotate("rect",xmin=as.numeric(as.yearmon("Oct 2014")), xmax=as.numeric(as.yearmon("Oct 2016")), 
           ymin=-Inf, ymax=+Inf, alpha=0.2, fill="dodgerblue")+
  annotate("rect",xmin=as.numeric(as.yearmon("Sep 2008")), xmax=as.numeric(as.yearmon("Nov 2009")), 
           ymin=-Inf, ymax=+Inf, alpha=0.2, fill="dodgerblue")+
  annotate("text",x=2010, y=Inf, vjust=1.25, hjust=0,
           label="Recession",color="dodgerblue",size=3,fontface="italic",alpha=0.6)+
  geom_line(color="firebrick",linetype="dashed",aes(y=Value))+
  geom_line(size=2,color="firebrick")+
  mytheme +
  scale_y_continuous(breaks=pretty_breaks(n=6)) +
  scale_x_yearmon(format="%Y")+
  labs(x="",y="Hours per Week",title="Average weekly hours in Alberta for Salaried Employees",
       subtitle=paste("Source: Own calculations from ",sourcetable,"-- for salaried workers only."),caption="Graph by @trevortombe")

# All provinces
plotdata<-wagedata %>%
  filter(Estimate=="Average weekly hours including overtime for hourly employees",Ref_Date>="Jan 2000") %>%
  group_by(GEO) %>%
  gettrend("Value")
ggplot(plotdata,aes(Ref_Date,TC,group=GEO))+
  geom_line() +
  geom_line(data=plotdata %>% filter(GEO=="Alberta"),color="firebrick",linetype="dashed",aes(y=Value))+
  geom_line(data=plotdata %>% filter(GEO=="Alberta"),size=2,color="firebrick")+
  geom_line(data=plotdata %>% filter(GEO=="Canada"),color="dodgerblue3",linetype="dashed",aes(y=Value))+
  geom_line(data=plotdata %>% filter(GEO=="Canada"),size=2,color="dodgerblue3")+
  mytheme +
  scale_y_continuous(breaks=pretty_breaks(n=6)) +
  scale_x_yearmon(format="%Y")+
  labs(x="",y="Hours per Week",title="Average weekly hours in Alberta for Hourly Employees",
       subtitle=paste("Source: Own calculations from ",sourcetable,"-- including overtime; for hourly employees only."),caption="Graph by @trevortombe")

plotdata<-wagedata %>%
  filter(Ref_Date==max(Ref_Date) & 
           Estimate %in% c("Standard work week excluding overtime for salaried employees (exclude overtime)",
                           "Average weekly hours including overtime for hourly employees")) %>%
  mutate(Estimate=ifelse(Estimate=="Average weekly hours including overtime for hourly employees","Hourly Employees","Salaried Employees"))
ggplot(plotdata,aes(short,Value,group=Estimate,fill=Estimate))+
  geom_col(position="dodge")+
  labs(title="Average hours worked, by province")

# Total hours
plotdata<-wagedata %>%
  filter(GEO==province & Estimate=="Employment for hourly paid employees") %>%
  filter(Ref_Date>="Jan 2010") %>%
  select(Ref_Date,emp_hrly=Value) %>%
  left_join(
    wagedata %>%
      filter(GEO==province & Estimate=="Employment for salaried employees") %>%
      filter(Ref_Date>="Jan 2010") %>% select(Ref_Date,emp_sal=Value), by="Ref_Date"
  ) %>%
  left_join(
    wagedata %>%
      filter(GEO==province & Estimate=="Average weekly hours including overtime for hourly employees") %>%
      filter(Ref_Date>="Jan 2010") %>% select(Ref_Date,hours_hrly=Value), by="Ref_Date"
  ) %>%
  left_join(
    wagedata %>%
      filter(GEO==province & Estimate=="Standard work week excluding overtime for salaried employees (exclude overtime)") %>%
      filter(Ref_Date>="Jan 2010") %>% select(Ref_Date,hours_sal=Value), by="Ref_Date"
  ) %>%
  mutate(total_hours=4*(emp_hrly*hours_hrly+emp_sal*hours_sal)/1000000,
         change=total_hours/total_hours[1]-1)
ggplot(plotdata,aes(Ref_Date,total_hours))+
  annotate("rect",xmin=as.numeric(as.yearmon("Oct 2014")), xmax=as.numeric(as.yearmon("Oct 2016")), 
           ymin=-Inf, ymax=+Inf, alpha=0.2, fill="dodgerblue")+
  annotate("text",x=2017, y=Inf, vjust=1.25, hjust=0,
           label="Recession",color="dodgerblue",size=3,fontface="italic",alpha=0.6)+
  geom_line(size=2,color="firebrick")+
  mytheme +
  scale_y_continuous(breaks=pretty_breaks(n=6),labels=comma) +
  scale_x_yearmon(format="%Y")+
  labs(x="",y="Millions of Hours per Month",title="Aggregate Hours of Payroll Employment",
       subtitle=paste("Source: Own calculations from ",sourcetable,"-- includes both hourly and salaried workers"),caption="Graph by @trevortombe")
```

# Counterfactuals

## If earnings grew with Canada
```{r counterfactual canada}
plotdata<-seph %>%
  filter(Estimate=="Average weekly earnings including overtime for all employees",
         grepl("Industrial aggregate excluding unclassified businesses",NAICS),
           GEO!="Canada" & GEO!="Alberta" & Ref_Date>="Jan 2010") %>%
  select(GEO,Ref_Date,CanadaEarnings=Value) %>%
  left_join(sephemp %>% select(GEO,Ref_Date,emp=Value),by=c("GEO","Ref_Date")) %>%
  group_by(Ref_Date) %>%
  summarise(CanadaEarnings=weighted.mean(CanadaEarnings,emp)) %>%
  left_join(
    seph %>%
  filter(Estimate=="Average weekly earnings including overtime for all employees",
         grepl("Industrial aggregate excluding unclassified businesses",NAICS),
           GEO=="Alberta" & Ref_Date>="Jan 2010") %>%
  select(Ref_Date,AlbertaEarnings=Value)
  ) %>%
    mutate(CanGrowth=CanadaEarnings/max(CanadaEarnings*(Ref_Date=="Oct 2014")),
           ABnew=ifelse(Ref_Date>="Oct 2014",CanGrowth*max(AlbertaEarnings*(Ref_Date=="Oct 2014")),AlbertaEarnings),
           gap=ABnew/AlbertaEarnings)
ggplot(plotdata,aes(Ref_Date))+
  geom_line(aes(y=ABnew),color="dodgerblue3",size=2)+
  geom_line(aes(y=AlbertaEarnings),color="firebrick",size=2)+
  annotate('text',x=2017.25,hjust=1,y=1255,label="If Alberta Earnings Grew at the\nSame Rate as the Rest of Canada",
           color="dodgerblue3",fontface="bold")+
  annotate('text',x=2016.5,hjust=1,y=1085,label="Data",color="firebrick",fontface="bold")+
  mytheme+
	scale_x_yearmon(format="%Y")+
  scale_y_continuous(label=dollar)+
  labs(x="",y="Dollars per Week",
       title="Average Weekly Earnings in Alberta",
       caption="Graph by @trevortombe",
       subtitle="Source: Own calculations from Statistics Canada data table 14-10-0223")

plotdata<-seph %>%
  filter(Estimate=="Average weekly earnings including overtime for all employees",
         grepl("Industrial aggregate excluding unclassified businesses",NAICS),
           GEO!="Canada" & GEO!="Alberta") %>%
  select(GEO,Ref_Date,CanadaEarnings=Value) %>%
  left_join(sephemp %>% select(GEO,Ref_Date,emp=Value),by=c("GEO","Ref_Date")) %>%
  group_by(Ref_Date) %>%
  summarise(CanadaEarnings=weighted.mean(CanadaEarnings,emp)) %>%
  left_join(
    seph %>%
  filter(Estimate=="Average weekly earnings including overtime for all employees",
         grepl("Industrial aggregate excluding unclassified businesses",NAICS),
           GEO=="Alberta") %>%
  select(Ref_Date,AlbertaEarnings=Value)
  ) %>%
    mutate(CanGrowth=CanadaEarnings/max(CanadaEarnings*(Ref_Date=="Jan 2010")),
           ABnew=ifelse(Ref_Date>="Jan 2010",CanGrowth*max(AlbertaEarnings*(Ref_Date=="Jan 2010")),AlbertaEarnings),
           #ABnew=CanGrowth*max(AlbertaEarnings*(Ref_Date=="Jan 2010")),
           gap=ABnew/AlbertaEarnings)
ggplot(plotdata %>% filter(Ref_Date>="Jan 2006"),aes(Ref_Date))+
  geom_line(aes(y=ABnew),color="dodgerblue3",size=2)+
  geom_line(aes(y=AlbertaEarnings),color="firebrick",size=2)+
  annotate('text',x=2012,hjust=0,y=950,label="If Alberta Earnings Grew at the\nSame Rate as the Rest of Canada",
           color="dodgerblue3",fontface="bold")+
  annotate('text',x=2016.5,hjust=1,y=1175,label="Data",color="firebrick",fontface="bold")+
  mytheme+
	scale_x_yearmon(format="%Y",n=6)+
  scale_y_continuous(label=dollar)+
  labs(x="",y="Dollars per Week",
       title="Average Weekly Earnings in Alberta",
       caption="Graph by @trevortombe",
       subtitle="Source: Own calculations from Statistics Canada data table 14-10-0223")

plotdata<-seph %>%
  filter(Estimate=="Average weekly earnings including overtime for all employees",
         grepl("Industrial aggregate excluding unclassified businesses",NAICS),
           GEO!="Canada" & GEO!="Alberta") %>%
  select(GEO,Ref_Date,CanadaEarnings=Value) %>%
  left_join(sephemp %>% select(GEO,Ref_Date,emp=Value),by=c("GEO","Ref_Date")) %>%
  group_by(Ref_Date) %>%
  summarise(CanadaEarnings=weighted.mean(CanadaEarnings,emp)) %>%
  left_join(
    seph %>%
  filter(Estimate=="Average weekly earnings including overtime for all employees",
         grepl("Industrial aggregate excluding unclassified businesses",NAICS),
           GEO=="Alberta") %>%
  select(Ref_Date,AlbertaEarnings=Value)
  ) %>%
    mutate(CanGrowth=CanadaEarnings/max(CanadaEarnings*(Ref_Date=="Jan 2001")),
           ABnew=ifelse(Ref_Date>="Jan 2001",CanGrowth*max(AlbertaEarnings*(Ref_Date=="Jan 2001")),AlbertaEarnings),
           gap=ABnew/AlbertaEarnings)
ggplot(plotdata %>% filter(Ref_Date>="Jan 2000"),aes(Ref_Date))+
  geom_line(aes(y=ABnew),color="dodgerblue3",size=2)+
  geom_line(aes(y=AlbertaEarnings),color="firebrick",size=2)+
  annotate('text',x=2017.25,hjust=1,y=1255,label="If Alberta Earnings Grew at the\nSame Rate as the Rest of Canada",
           color="dodgerblue3",fontface="bold")+
  annotate('text',x=2016.5,hjust=1,y=1085,label="Data",color="firebrick",fontface="bold")+
  mytheme+
	scale_x_yearmon(format="%Y")+
  scale_y_continuous(label=dollar)+
  labs(x="",y="Dollars per Week",
       title="Average Weekly Earnings in Alberta",
       caption="Graph by @trevortombe",
       subtitle="Source: Own calculations from Statistics Canada data table 14-10-0223")


```

## If overtime remained unchanged
```{r overtime fixed}
plotdata<-OTpay %>%
  filter(GEO=="Alberta",NAICS=="Industrial aggregate excluding unclassified businesses") %>%
  select(Ref_Date,Overtime,Value) %>%
  spread(Overtime,Value) %>%
  mutate(Overtime=`Including overtime`/`Excluding overtime`-1)
ggplot(plotdata,aes(Ref_Date,Overtime))+stat_seas()+
  scale_y_continuous(label=percent)+
  labs(title="Average hourly earnings, ratio of 'with OT' versus 'without OT'",y="Per Cent",
       subtitle="Read as: overtime hours equivalent to X% additional pay per hour across all hours")

plotdata<-OThours %>%
  filter(GEO=="Alberta",NAICS=="Industrial aggregate excluding unclassified businesses") %>%
  select(GEO,Ref_Date,Overtime,Value) %>%
  spread(Overtime,Value) %>%
  mutate(Value=`Including overtime`-`Excluding overtime`) %>%
  getseas("GEO")
ggplot(plotdata,aes(Ref_Date,TC))+
  annotate("rect",xmin=as.numeric(as.yearmon("Oct 2014")), xmax=as.numeric(as.yearmon("Oct 2016")), 
           ymin=-Inf, ymax=+Inf, alpha=0.2, fill="dodgerblue")+
  annotate("rect",xmin=as.numeric(as.yearmon("Sep 2008")), xmax=as.numeric(as.yearmon("Nov 2009")), 
           ymin=-Inf, ymax=+Inf, alpha=0.2, fill="dodgerblue")+
  annotate("text",x=2010, y=Inf, vjust=1.25, hjust=0,
           label="Recession",color="dodgerblue",size=3,fontface="italic",alpha=0.6)+
  geom_line(aes(y=Value),linetype="dashed",color="firebrick")+
  geom_line(size=2,color="firebrick")+
  labs(x="",title="Average overtime hours in Alberta",y="Hours per week",
       caption="Graph by @trevortombe",
       subtitle="Source: Own calculations from Statistics Canada data table 14-10-0255.")+
	mytheme +
	scale_x_yearmon(format="%Y")


test<-OTpay %>%
  filter(Overtime=="Including overtime") %>%
  rename(wage=Value) %>%
  mutate(levels=nchar(NAICScode)) %>%
  #filter(GEO=="Alberta",(levels==2 | levels==3 | NAICScode=="31-33" | NAICScode=="61,611")) %>%
  filter(GEO=="Alberta",NAICScode %in% c("11N","21","22,221","23","31-33","41-45N","48-49","51",
                                         "52","53","54,541","56","61,611","62","72","81")) %>%
  select(GEO,Ref_Date,NAICS,wage) %>%
  drop_na() %>%
  left_join(jobdetailed %>% filter(Type.of.employee=="Employees paid by the hour") %>%
              select(GEO,NAICS,Ref_Date,emp=Value),by=c("NAICS","Ref_Date","GEO")) %>%
  drop_na() %>%
  group_by(NAICS) %>%
  mutate(baseweight=max((Ref_Date=="Oct 2014")*emp)) %>%
  group_by(Ref_Date) %>%
  summarise(wage_data=weighted.mean(wage,emp),
            wage_fixed=weighted.mean(wage,baseweight)) %>%
  mutate(wage_sec_adj=wage_fixed/wage_data)
test2<-OThours %>%
  filter(Overtime=="Including overtime") %>%
  rename(hours=Value) %>%
  mutate(levels=nchar(NAICScode)) %>%
  #filter(GEO=="Alberta",(levels==2 | levels==3 | NAICScode=="31-33" | NAICScode=="61,611")) %>%
  filter(GEO=="Alberta",NAICScode %in% c("11N","21","22,221","23","31-33","41-45N","48-49","51",
                                         "52","53","54,541","56","61,611","62","72","81")) %>%
  select(GEO,Ref_Date,NAICS,hours) %>%
  drop_na() %>%
  left_join(jobdetailed %>% filter(Type.of.employee=="Employees paid by the hour") %>%
              select(GEO,NAICS,Ref_Date,emp=Value),by=c("NAICS","Ref_Date","GEO")) %>%
  drop_na() %>%
  group_by(NAICS) %>%
  mutate(baseweight=max((Ref_Date=="Oct 2014")*emp)) %>%
  group_by(Ref_Date) %>%
  summarise(hours_data=weighted.mean(hours,emp),
         hours_fixed=weighted.mean(hours,baseweight)) %>%
  mutate(hrs_sec_adj=hours_fixed/hours_data)

# as above, but for salaried
test3<-earn_salary_data %>%
  mutate(levels=nchar(NAICScode)) %>%
  #filter(GEO=="Alberta",(levels==2 | levels==3 | NAICScode=="31-33" | NAICScode=="61,611")) %>%
  filter(GEO=="Alberta",NAICScode %in% c("11N","21","22,221","23","31-33","41-45N","48-49","51",
                                         "52","53","54,541","56","61,611","62","72","81")) %>%
  select(GEO,Ref_Date,NAICS,Value) %>%
  drop_na() %>%
  left_join(jobdetailed %>% filter(Type.of.employee=="Salaried employees paid a fixed salary") %>%
              select(GEO,NAICS,Ref_Date,emp=Value),by=c("NAICS","Ref_Date","GEO")) %>%
  drop_na() %>%
  group_by(NAICS) %>%
  mutate(baseweight=max((Ref_Date=="Oct 2014")*emp)) %>%
  group_by(Ref_Date) %>%
  summarise(wage_data=weighted.mean(Value,emp),
            wage_fixed=weighted.mean(Value,baseweight)) %>%
  #gather(type,Value,-Ref_Date) %>%
  #getseas("type") %>%
  #select(type,Value,Ref_Date) %>%
  #spread(type,Value) %>%
  mutate(wage_sec_adj_salary=wage_fixed/wage_data)
test4<-hours_salary_data %>%
  rename(hours=Value) %>%
  mutate(levels=nchar(NAICScode)) %>%
  #filter(GEO=="Alberta",(levels==2 | levels==3 | NAICS=="31-33" | NAICS=="61,611")) %>%
  filter(GEO=="Alberta",NAICScode %in% c("11N","21","22,221","23","31-33","41-45N","48-49","51",
                                         "52","53","54,541","56","61,611","62","71","72","81","91")) %>%
  select(GEO,Ref_Date,NAICS,hours) %>%
  drop_na() %>%
  left_join(jobdetailed %>% filter(Type.of.employee=="Salaried employees paid a fixed salary") %>%
              select(GEO,NAICS,Ref_Date,emp=Value),by=c("NAICS","Ref_Date","GEO")) %>%
  drop_na() %>%
  group_by(NAICS) %>%
  mutate(baseweight=max((Ref_Date=="Oct 2014")*emp)) %>%
  group_by(Ref_Date) %>%
  summarise(hours_data=weighted.mean(hours,emp),
         hours_fixed=weighted.mean(hours,baseweight)) %>%
  mutate(hrs_sec_adj_salary=hours_fixed/hours_data)


noOT<-OTpay %>%
  filter(GEO=="Alberta",NAICS=="Industrial aggregate excluding unclassified businesses") %>%
  select(Ref_Date,Overtime,Value) %>%
  spread(Overtime,Value) %>%
  mutate(wage_adjust=`Including overtime`/`Excluding overtime`) %>% 
  select(Ref_Date,wage_adjust) %>%
  mutate(OT_wage_adjust=max(wage_adjust*(Ref_Date=="Oct 2014"))/wage_adjust) %>%
  left_join(
    OThours %>%
      filter(GEO=="Alberta",NAICS=="Industrial aggregate excluding unclassified businesses") %>%
      select(GEO,Ref_Date,Overtime,Value) %>%
      spread(Overtime,Value) %>%
      mutate(OT_hours=`Including overtime`-`Excluding overtime`) %>%
      select(Ref_Date,OT_hours) %>%
      mutate(OT_hours_adjust=max(OT_hours*(Ref_Date=="Oct 2014"))-OT_hours)
  )
grow_with_canada <- fixedweight %>%
  filter(GEO %in% c("Canada","Alberta"),NAICS=="Industrial aggregate excluding unclassified businesses") %>%
  getseas("GEO") %>%
  group_by(GEO) %>%
  mutate(Value=100*Value/max(Value*(Ref_Date=="Oct 2014")),
         TC=100*TC/max(TC*(Ref_Date=="Oct 2014"))) %>%
  filter(Ref_Date>="Oct 2014") %>%
  select(Ref_Date,GEO,TC) %>%
  spread(GEO,TC) %>%
  mutate(grow_with_canada=Canada/Alberta)
plotdata<-wagedata %>%
  filter(GEO=="Alberta" & Estimate=="Employment for hourly paid employees") %>%
  filter(Ref_Date>="Jan 2010") %>%
  select(Ref_Date,emp_hrly=Value) %>%
  left_join(
    wagedata %>%
      filter(GEO=="Alberta" & Estimate=="Employment for salaried employees") %>%
      filter(Ref_Date>="Jan 2010") %>% select(Ref_Date,emp_sal=Value), by="Ref_Date"
  ) %>%
  left_join(
    wagedata %>%
      filter(GEO=="Alberta" & Estimate=="Average weekly hours including overtime for hourly employees") %>%
      filter(Ref_Date>="Jan 2010") %>% select(Ref_Date,hours_hrly=Value), by="Ref_Date"
  ) %>%
  left_join(
    wagedata %>%
      filter(GEO=="Alberta" & Estimate=="Standard work week excluding overtime for salaried employees (exclude overtime)") %>%
      filter(Ref_Date>="Jan 2010") %>% select(Ref_Date,hours_sal=Value), by="Ref_Date"
  ) %>%
  left_join(
    wagedata %>%
      filter(GEO=="Alberta" & Estimate=="Average hourly earnings including overtime for hourly employees") %>%
      filter(Ref_Date>="Jan 2010") %>% select(Ref_Date,wage_hrly=Value), by="Ref_Date"
  ) %>%
  left_join(
    wagedata %>%
      filter(GEO=="Alberta" & Estimate=="Average hourly earnings including overtime for salaried employees") %>%
      filter(Ref_Date>="Jan 2010") %>% select(Ref_Date,wage_sal=Value), by="Ref_Date"
  ) %>%
  left_join(noOT, by="Ref_Date") %>%
  left_join(test %>% select(Ref_Date,wage_sec_adj), by="Ref_Date") %>%
  left_join(test2 %>% select(Ref_Date,hrs_sec_adj), by="Ref_Date") %>%
  left_join(test3 %>% select(Ref_Date,wage_sec_adj_salary), by="Ref_Date") %>%
  left_join(test4 %>% select(Ref_Date,hrs_sec_adj_salary), by="Ref_Date") %>%
  left_join(grow_with_canada %>% select(Ref_Date,grow_with_canada), by="Ref_Date") %>%
  mutate(avgearn=(emp_hrly*hours_hrly*wage_hrly+emp_sal*hours_sal*wage_sal)/(emp_hrly+emp_sal),
         hrly_share=emp_hrly/(emp_hrly+emp_sal),
         hrly_share2014=max(hrly_share*(Ref_Date=="Oct 2014")),
         hours2014_hrly=max(hours_hrly*(Ref_Date=="Oct 2014")),
         hours2014_sal=max(hours_sal*(Ref_Date=="Oct 2014")),
         avgearn_fixedhours=(emp_hrly*hours2014_hrly*wage_hrly+emp_sal*hours2014_sal*wage_sal)/(emp_hrly+emp_sal),
         avgearn_fixedhrlyshare=(hrly_share2014*hours2014_hrly*wage_hrly+(1-hrly_share2014)*hours2014_sal*wage_sal),
         avgearn_noOTchange=(hrly_share2014*hours2014_hrly*wage_hrly*OT_wage_adjust+(1-hrly_share2014)*hours2014_sal*wage_sal),
         avgearn_noOTchange_sec=(hrly_share2014*hours2014_hrly*wage_hrly*OT_wage_adjust*wage_sec_adj+(1-hrly_share2014)*hours2014_sal*wage_sal*wage_sec_adj_salary),
         with_canada=avgearn_noOTchange_sec*grow_with_canada,
         ratio=avgearn_fixedhrlyshare/avgearn) %>%
  select(Ref_Date,avgearn,avgearn_fixedhrlyshare,avgearn_noOTchange_sec,with_canada) %>%
  gather(type,value,-Ref_Date) %>%
  filter(!(Ref_Date<"Oct 2014" & type!="avgearn"),Ref_Date>="Jan 2011") %>%
  mutate(type=ifelse(type=="avgearn","Data",type),
         type=ifelse(type=="with_canada","National Wage Growth",type),
         type=ifelse(type=="avgearn_fixedhrlyshare","Fixed Hours/OT",type),
         type=ifelse(type=="avgearn_noOTchange_sec","Fixed Sectoral Emp.",type))

# Superimpose these results on the average weekly earnings data
plotdata2<-seph %>%
      filter(Estimate=="Average weekly earnings including overtime for all employees",GEO=="Alberta",
             grepl("Industrial aggregate excluding unclassified businesses",NAICS)) %>%
      select(Ref_Date,Data=Value) %>%
  left_join(
    plotdata %>%
      spread(type,value) %>%
      filter(Ref_Date>="Oct 2014") %>%
      mutate(`Fixed Hours/OT`=`Fixed Hours/OT`/Data,
         `Fixed Sectoral Emp.`=`Fixed Sectoral Emp.`/Data,
         `National Wage Growth`=`National Wage Growth`/Data) %>%
      select(-Data),by="Ref_Date"
  ) %>%
      mutate(`Fixed Hours/OT`=`Fixed Hours/OT`*Data,
         `Fixed Sectoral Emp.`=`Fixed Sectoral Emp.`*Data,
         `National Wage Growth`=`National Wage Growth`*Data) %>%
  gather(type,value,-Ref_Date) %>%
  filter(Ref_Date>="Jan 2010")
ggplot(plotdata2 %>% filter(type!="National Wage Growth",
                            type!="Fixed Sectoral Emp."),aes(Ref_Date,value,group=type,color=type))+
  geom_line(size=2,show.legend = F)+
  geom_text(data=plotdata2 %>% filter(Ref_Date==max(Ref_Date)) %>% filter(type!="National Wage Growth",
                            type!="Fixed Sectoral Emp."),show.legend = F,
            aes(label=type),fontface="bold",hjust=0,nudge_x=1/6)+
  mytheme+
  scale_y_continuous(label=dollar)+
  scale_x_yearmon(limit=c(NA,max(plotdata$Ref_Date)+3),format="%Y")+
  scale_color_brewer(name="",palette="Set1")+
  labs(y="Dollars per Week",x="",
       caption="Source: Calculations and visualization by @trevortombe, based on various Statistics Canada SEPH data",
       subtitle="Displays average weekly earnings of Albertans in the data, and what earnings would have been if various factors
were held fixed at their pre-recession (Oct 2014) values. Starting from the data, each counterfactual builds on the last.",
       title="Average Weekly Earnings in Alberta")
```

## If OT, Hours, and Sectoral Composition Unchanged
```{r counterfactual all-in}
ggplot(plotdata2,aes(Ref_Date,value,group=type,color=type))+
  geom_line(size=2,show.legend = F)+
  geom_text(data=plotdata2 %>% filter(Ref_Date==max(Ref_Date)),show.legend = F,
            aes(label=type),fontface="bold",hjust=0,nudge_x=1/6)+
  mytheme+
  scale_y_continuous(label=dollar)+
  scale_x_yearmon(limit=c(NA,max(plotdata$Ref_Date)+3),format="%Y")+
  scale_color_brewer(name="",palette="Set1")+
  labs(y="Dollars per Week",x="",
       caption="Source: Calculations and visualization by @trevortombe, based on various Statistics Canada SEPH data",
       subtitle="Displays average weekly earnings of Albertans in the data, and what earnings would have been if various factors
were held fixed at their pre-recession (Oct 2014) values. Starting from the data, each counterfactual builds on the last.",
       title="Average Weekly Earnings in Alberta")

plotdata2 %>% filter(Ref_Date==max(Ref_Date))

# Relabelled
plotdata2b<-plotdata2 %>%
  select(Ref_Date,value,type) %>%
  spread(type,value) %>%
  select(Ref_Date,Data) %>%
  left_join(
    fixedweight %>%
        filter(GEO %in% c("Canada","Alberta"),NAICS=="Industrial aggregate excluding unclassified businesses",Ref_Date>="Jan 2010") %>%
        getseas("GEO") %>%
        group_by(GEO) %>%
        mutate(Value=100*Value/max(Value*(Ref_Date=="Oct 2014")),
               TC=100*TC/max(TC*(Ref_Date=="Oct 2014"))) %>%
      select(Ref_Date,GEO,TC) %>%
      spread(GEO,TC) %>%
      mutate(ratio=Canada/Alberta) %>%
      select(Ref_Date,ratio),by="Ref_Date"
  ) %>%
  mutate(ratio=ifelse(Ref_Date>="Oct 2014",ratio*Data,Data)) %>%
  gather(type,value,-Ref_Date) %>%
    mutate(type=ifelse(type=="ratio","If Wage Growth\nMatched Canada's",type))
ggplot(plotdata2b,aes(Ref_Date,value,group=type,color=type))+
  geom_line(size=2,show.legend = F)+
  geom_line(data=plotdata2b %>% filter(type=="Data"),
            size=2,show.legend = F,color="firebrick")+ # to fix colors
  geom_text(data=plotdata2b %>% filter(Ref_Date==max(Ref_Date)),show.legend = F,
            aes(label=type),fontface="bold",hjust=0,nudge_x=1/6)+
  mytheme+
  scale_y_continuous(label=dollar,limit=c(1040,1250))+
  scale_x_yearmon(limit=c(2012,max(plotdata$Ref_Date)+2),format="%Y")+
  scale_color_manual(name="",values=c("firebrick","dodgerblue3"))+
  labs(y="Dollars per Week",x="",
       caption="Source: Calculations and visualization by @trevortombe, based on various Statistics Canada SEPH data.
Uses the trend-cycle estimate of the fixed-weight wage index from 14-10-0213-01.",
       subtitle="Displays average weekly earnings of Albertans in the data, and what earnings would have been if hourly wages grew at the 
same rate as the rest of Canada, holding fixed hours/overtime/employment composition/etc.",
       title="Average Weekly Earnings in Alberta if Wage Growth Matched Canada's")

plotdata2b %>% filter(Ref_Date==max(Ref_Date))

# waterfall of the earnings gap
plotdata3<-data.frame(
  type=c("Earnings","Fixed\nHours/OT","Fixed Hours/OT\nand Sectors",
           "If Grew\nwith Canada","Counterfactual"),
  value=c(0,33,48,38,1301-1182)
) %>%
  mutate(type=factor(type,levels=type),
         id=seq_along(value),
         sign=ifelse(value>0,"in","out"),
         sign=ifelse(id==n(),"net",sign),
         end=cumsum(value),
         end=ifelse(id==n(),0,end),
         start=ifelse(id>1,lag(end,1),0))
ggplot(plotdata3)+
  geom_rect(aes(x=type,xmin = id - 0.4, xmax = id + 0.4,ymin=end,ymax=start,fill=sign),show.legend = F)+
  geom_hline(yintercept=0,size=1)+
  geom_segment(data=plotdata3 %>% filter(sign!="net"),aes(x=id+0.45,xend=id+0.45,y=start,yend=end),
               size=0.75,arrow=arrow(type="closed",length=unit(0.1,"cm")))+
  mythemebar+
  scale_fill_manual(name="",values=c("#377EB8","#4DAF4A","#E41A1C"))+
  scale_y_continuous(breaks=pretty_breaks(n=6),label=dollar)+
  labs(x="",y="Millions of Dollars",
       title="Change in Alberta's 2017-18 Deficit, by Component",
       subtitle="Source: Alberta Q3 Fiscal Update, 2017-18.",
       caption="* The Balancing Pool owns many of the cancelled coal power PPAs; when electricity prices rise, so does its revenue.
Graph by @trevortombe")


plotdata2 %>%
  select(Ref_Date,type,value) %>%
  filter(Ref_Date>="Oct 2014") %>%
  spread(type,value) %>%
  mutate(hours=`Fixed Hours/OT`-`Data`,
         sectoral=`Fixed Sectoral Emp.`-`Fixed Hours/OT`,
         wages=`National Wage Growth`-`Fixed Sectoral Emp.`) %>%
  select(Ref_Date,hours,sectoral,wages) %>%
  gather(type,value,-Ref_Date) %>%
  group_by(type) %>%
  mutate(change=value-value[1],
         change_MoM=value-lag(value,1)) %>%
  ggplot(aes(Ref_Date,change,group=type,color=type))+
  geom_line(size=1)

```


# Oil and Gas Detail

```{r oil and gas}
plotdata<-jobdetailed %>%
  filter(GEO=="Alberta" & Type.of.employee=="All employees" & 
           (grepl("Oil and gas extraction",NAICS) | grepl("Mining and quarrying",NAICS) |
              grepl("Support activities for mining, and oil and gas extraction",NAICS))) %>%
  mutate(NAICS=replace(NAICS,grepl("Mining and quarrying",NAICS),"Mining and quarrying"),
         NAICS=replace(NAICS,grepl("Support activities",NAICS),"Support activities"),
         NAICS=replace(NAICS,grepl("Oil and gas extraction",NAICS),"Oil and gas extraction"),
         Ref_Date=as.yearmon(Ref_Date,"%Y/%m"))
ggplot(plotdata %>% filter(Ref_Date>="Jan 2013"),aes(x=Ref_Date,y=Value,group=NAICS,color=NAICS)) +
  annotate("rect",xmin=as.numeric(as.yearmon("Oct 2014")), xmax=as.numeric(as.yearmon("Oct 2016")), 
           ymin=-Inf, ymax=+Inf, alpha=0.2, fill="dodgerblue")+
  annotate("text",x=2015.71, y=max(pretty(plotdata$Value)), hjust=0.5, 
           label="AB Recession",color="black",size=3,fontface="italic")+
  geom_line(size=2) +
	geom_hline(aes(yintercept=0), colour="black", size=1) +
	mytheme +
	scale_colour_brewer(name="",palette="Set1") +
	scale_y_continuous(breaks=pretty_breaks(n=10),labels=comma) +
	scale_x_yearmon(format="%Y") +
	labs(x="",y="Persons",title="Payroll Employment in Alberta Mining, Oil and Gas",
		subtitle="Source: Own calculations from Statistics Canada data table 14-10-0201.",caption="Graph by @trevortombe")
```

# Diffusion Index

```{r diffusion}
plotdata<-jobdetailed %>%
  filter(!(NAICS %in% c("Industrial aggregate including unclassified businesses",
                                                                        "Industrial aggregate excluding unclassified businesses",
                                                                        "Goods producing industries","Manufacturing",
                                                                        "Non-durable goods","Durable goods",
                                                                        "Service producing industries","Trade")),
         Type.of.employee=="All employees",GEO=="Alberta") %>%
  group_by(GEO,NAICS) %>%
  arrange(GEO,NAICS) %>%
  mutate(grow=Value>lag(Value,12)) %>%
  filter(!is.na(grow)) %>%
  group_by(GEO,Ref_Date) %>%
  summarise(share=mean(grow)) %>%
  filter(Ref_Date>="Jan 2005")
ggplot(plotdata,aes(Ref_Date,share))+geom_line(size=2,color="firebrick")+
  geom_hline(yintercept=0.5,size=1)+
  mytheme+
  scale_y_continuous(label=percent)+
  scale_x_continuous(breaks=pretty_breaks(n=6))+
  labs(x="",y="Per Cent",
       title="The Breadth of Alberta's Jobs Recovery (a `Diffusion Index`)",
       subtitle="Displays the share of disaggregated NAICS sectors with higher payroll employment than 12 months prior. When above the
black line, more sectors are expanding than shrinking. Below the line, more sectors are shrinking than expanding.",
       caption="Source: Own calculations from Statistics Canada data table 14-10-0201. Note: I exclude high-level aggregates, but some double counting remains. Graph by @trevortombe")
```

# Vacancy-to-Unemployment

```{r vacancy_data}
vanunemp<-getTABLE("14100226")
```

```{r vacancy_plots}
plotdata<-vanunemp %>%
  filter(Job.vacancy.statistics=="Unemployment-to-job vacancies ratio",
         grepl("All unemployed",NAICS),
         GEO %in% c("Canada","Alberta","Saskatchewan"))
ggplot(plotdata,aes(Ref_Date,Value,group=GEO,color=GEO)) +
  annotate("rect",xmin=as.numeric(as.yearmon("Oct 2014")), xmax=as.numeric(as.yearmon("Oct 2016")), 
           ymin=0, ymax=+Inf, alpha=0.2, fill="dodgerblue")+
  annotate("text",x=2015.71, y=Inf, vjust=1, hjust=0.5, 
           label="AB Recession",color="black",size=3,fontface="italic")+
  geom_line(size=2) +
  geom_point(data=plotdata %>% filter(Ref_Date==max(Ref_Date)),size=4,show.legend = F)+
  geom_hline(aes(yintercept=0), colour="black", size=1) +
  geom_text(data=plotdata[plotdata$Ref_Date==max(vanunemp$Ref_Date),],
            aes(x=Ref_Date,y=Value,label=Value,color=GEO,group=GEO),nudge_x=0.25,vjust=-0.25,
            fontface="bold",size=4,show.legend=F) +
  mytheme +
  scale_colour_brewer(name="",palette="Set1") +
  scale_y_continuous(breaks=pretty_breaks(n=10),expand=c(0,0),limit=c(0,9)) +
  scale_x_yearmon(limit=c(NA,today+1/2),format = "%Y") +
  labs(x="",y="Workers per Vacancy",title="Unemployed Workers per Job Vacancy",
       subtitle="Source: Statistics Canada data table 14-10-0226",caption="Graph by @trevortombe")
plotdata<-vanunemp %>%
  filter(Job.vacancy.statistics=="Unemployment-to-job vacancies ratio",
         grepl("All unemployed",NAICS)) %>%
  filter(Ref_Date==max(Ref_Date) | Ref_Date==(max(Ref_Date)-1)) %>%
  filter(!(short %in% c("CAN","NU","YT","NT")) & !is.na(short))
ggplot(plotdata, aes(x=short,y=Value,group=as.character(Ref_Date),fill=as.character(Ref_Date))) +
  geom_col(position="dodge") +
  geom_hline(aes(yintercept=0), colour="black", size=1) +
  mythemebar+
  theme(legend.position = c(0.1,0.8))+
  scale_fill_brewer(name="",palette="Set1") +
  scale_y_continuous(breaks=pretty_breaks(n=10),expand=c(0,0)) +
  labs(x="",y="Unemployed per Vacancy",title="Unemployed Workers per Job Vacancy",
       subtitle="Source: Statistics Canada data table 14-10-0226",caption="Graph by @trevortombe")
```

